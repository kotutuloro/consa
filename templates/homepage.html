{% extends 'base.html' %}

{% block subtitle %}
{% endblock %}

{% block content %}

  <div id="search-form">

    <form id="loc-search-form">
      <label for="location-input">Location:</label>
        <input type="text" id="location-input" name="location" value="{{ session.get('locName', 'SF Bay Area') }}">
      <input type="submit" id="loc-search-button" value="Search">
    </form>

    <br>
    <form id="spotify-auth-form">
      <button id="spotify-auth" type="submit">Use your Spotify account's top artists</button>
    </form>

    OR
    <br>
    <button id="specify-artists">Use specific artists instead</button>

    <div id="spotify-artist-search" hidden>
      <br>
      <form id="artist-search-form">
        <label for="artist-input">Search for up to 10 artists:</label>
          <input type="text" id="artist-input" name="artist">
        <input type="submit" id="artist-search-button" value="Search">
      </form>

      <div id="chosen-artists">
        <h3>Selected Artists:</h3>
      </div>
    </div>

  </div>
  <br>
  <br>
  <div id="attributions">
    Built using <img style="max-width: 100px" src="/static/img/spotify-logo-rgb-green.png"> and <img style="max-width: 100px" src="/static/img/by-songkick-black.png">
  </div>
  
{% endblock %}

{% block js %}
  <script>
    // Send location search to Songkick API via GET request
    function searchSongkickLoc(evt) {
      evt.preventDefault();

      // Create fieldset for locations
      var locFieldset = $("<fieldset>").attr("id", "loc-selection").hide();
      var legend = $("<legend>").text("Choose your area:");

      var loadingDiv = $("<div>").attr("id", "loc-loading").text("Loading...")
      var loadingImg = $("<img>").attr("src", "/static/img/load-gps.gif");
      loadingDiv.append(loadingImg);

      locFieldset.append(legend, loadingDiv);

      // Remove the previous fieldset and append new fieldset to form
      $("#loc-selection").remove();
      $("#loc-search-form").append(locFieldset);
      locFieldset.slideDown();

      // Make GET request to server and display locations
      var searchTerm = $("#location-input").val();
      $.get("/location-search", {'search-term': searchTerm}, displayLocs)
    }


    // Display locations from JSON response from Songkick API
    function displayLocs(locations) {
      // Remove loading notification
      $("#loc-loading").slideUp();

      // If locations found
      if (locations) {

        // Iterate through list of locations
        for (var i = 0; i < locations.length; i++) {

          // Get the metro area's information
          var metro = locations[i];
          var locID = metro.id;

          // Create location's name from metro area's display name, county, and state (if available)
          if (metro.state) {
            var locName = metro.displayName + ", " + metro.state.displayName + ", " + metro.country.displayName;
          } else {
            var locName = metro.displayName + ", " + metro.country.displayName;
          }

          // Create a radio button using the location's ID and name
          var locRadio = '<input type="radio" name="sk-loc" value="sk:' + locID + '">' + locName + '<br>';

          // Append radio button to location selection fieldset
          $("#loc-selection").append(locRadio);

          // Add ID & name to new radio button's data
          var latest = $("#loc-selection input:last");
          latest.data({"locID": "sk:" + locID, "locName": locName});
        }

      // If no locations found, inform user
      } else {
        $("#loc-selection").append("No matching areas found.");
      }
    }


    // Send artist search to Spotify API via GET request
    function searchSpotifyArtist(evt) {
      evt.preventDefault();

      // Create div for artist results
      var artistSelectionDiv = $("<div>").attr("id", "artist-selection").hide();
      var legend = $("<h3>").text("Choose the correct artist(s):");

      var loadingDiv = $("<div>").attr("id", "artist-loading").text("Loading...")
      var loadingImg = $("<img>").attr("src", "/static/img/load-gps.gif");
      loadingDiv.append(loadingImg);

      artistSelectionDiv.append(legend, loadingDiv);

      // Remove the previous artist selection div and append new div to form
      $("#artist-selection").remove();
      $("#artist-search-form").append(artistSelectionDiv);
      artistSelectionDiv.slideDown();

      // Make GET request to server and display artist results
      var searchTerm = $("#artist-input").val();
      $.get("/artist-search", {'search-term': searchTerm}, displayArtists)

          // Display error message if GET request fails
          .fail(function(err){
            $("#artist-loading").slideUp();
            $("#artist-selection").append("Artist search failed <br>" + 
                                          err.status + ": " + err.statusText);
          });
    }


    // Display artists from JSON response from Spotify API
    function displayArtists(artists) {
      // Remove loading notification
      $("#artist-loading").slideUp();

      // If artists found
      if (artists) {

        // Iterate through list of artists
        for (var i = 0; i < artists.length; i++) {

          // FIXME: Display the artists in individual divs
          
        }

      // If no artists found, inform user
      } else {
        $("#artist-selection").append("No matching artists found.");
      }
    }


    // Call Songkick Search function on click
    $("#loc-search-button").on('click', searchSongkickLoc);


    // Toggle artist search div on click
    $("#specify-artists").on('click', function(evt) {
      $("#spotify-artist-search").slideToggle();
    });


    // Call Spotify artist search function on click
    $("#artist-search-button").on('click', searchSpotifyArtist);


    // Save location and redirect to Spotify authorization
    $("#spotify-auth").on('click', function(evt) {
      evt.preventDefault();

      // Find selected location
      var selectedLoc = $('input[name="sk-loc"]:checked');
      
      // Send request to server with location's data and open returned url
      $.get('/spotify-auth', selectedLoc.data(), function(authurl) {
        window.location = authurl;
      });

    });

  </script>
{% endblock %}