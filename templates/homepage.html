{% extends 'base.html' %}

{% block subtitle %}
{% endblock %}

{% block content %}

  <div id="search-form">
    <form id="loc-search-form">
      <label for="location-input">Location:</label>
        <input type="text" id="location-input" name="location" value="{{ session.get('locName', 'SF Bay Area') }}">
      <input type="submit" id="loc-search-button" value="Search">
    </form>
    <br>
    <button id="spotify-auth" type="button">Authorize your Spotify account</button>
  </div>
  
{% endblock %}

{% block js %}
  <script>
    // Send location search to Songkick API via GET request
    function searchSongkickLoc(evt) {
      evt.preventDefault();

      // Create fieldset for locations
      var locFieldset = $("<fieldset>").attr("id", "loc-selection").hide();
      var legend = $("<legend>").text("Choose your area:");

      var loadingDiv = $("<div>").attr("id", "loc-loading").text("Loading...")
      var loadingImg = $("<img>").attr("src", "/static/img/load-gps.gif");
      loadingDiv.append(loadingImg);

      locFieldset.append(legend, loadingDiv);

      // Remove the previous fieldset and append new fieldset to form
      $("#loc-selection").remove();
      $("#loc-search-form").append(locFieldset);
      locFieldset.slideDown();

      // Make GET request to server and display locations
      var searchTerm = $("#location-input").val();
      $.get("/location-search", {'search-term': searchTerm}, displayLocs)
    }


    // Display locations from JSON response from Songkick API
    function displayLocs(locations) {
      // Remove loading notification
      $("#loc-loading").slideUp();

      // If locations found
      if (locations) {

        // Iterate through list of locations
        for (var i = 0; i < locations.length; i++) {

          // Get the metro area's information
          var metro = locations[i];
          var locID = metro.id;

          // Create location's name from metro area's display name, county, and state (if available)
          if (metro.state) {
            var locName = metro.displayName + ", " + metro.state.displayName + ", " + metro.country.displayName;
          } else {
            var locName = metro.displayName + ", " + metro.country.displayName;
          }

          // Create a radio button using the location's ID and name
          var locRadio = '<input type="radio" name="sk-loc" value="sk:' + locID + '">' + locName + '<br>';

          // Append radio button to location selection fieldset
          $("#loc-selection").append(locRadio);

          // Add ID & name to new radio button's data
          var latest = $("#loc-selection input:last");
          latest.data({"locID": "sk:" + locID, "locName": locName});
        }

      // If no locations found, inform user
      } else {
        $("#loc-selection").append("No matching areas found.");
      }
    }


    // Call Songkick Search function on click
    $("#loc-search-button").on('click', searchSongkickLoc);


    // Save location and redirect to Spotify authorization
    $("#spotify-auth").on('click', function() {
      // Find selected location
      var selectedLoc = $('input[name="sk-loc"]:checked');
      
      // Send request to server with location's data and open returned url
      $.get('/spotify-auth', selectedLoc.data(), function(authurl) {
        window.location = authurl;
      });

    });

  </script>
{% endblock %}