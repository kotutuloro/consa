{% extends 'base.html' %}

{% block subtitle %}
  : Concert Recommendations
{% endblock %}

{% block content %}
  <h1>Results</h1>

  <div id="concert-results" hidden>
    <h3>Concerts you might be interested in</h3>
    <img style="max-width: 200px" src="/static/img/powered-by-songkick-black.png">
    <div id="sort-results" hidden>
      Sort results by
      <button class="sort-by-date">Date</button>
      <button class="sort-by-artist">Artist</button>
    </div>
    <br>
  </div>

  <div id="results-loading">
    <h2>FINDING CONCERTS...</h2>
    <img src="/static/img/load-hourglass.gif"><br>
    This may take a minute
  </div>

  <div id="no-results" hidden>
  </div>

{% endblock %}

{% block js %}
  <script>
    // Get variables from server
    var userSavedConcerts = {{ user_saved_concerts }};
    var authCode = "{{ auth_code }}";

    var selectedArtists = {};
    {% for spotID in selected_artists %}
      selectedArtists["{{ spotID }}"] = "{{ selected_artists[spotID] }}";
    {% endfor %}

    // Declare variables to keep track of end of get requests 
    var resultCount;
    var expectedResults;
    
    // If user logged in, addConcert on button click
    {% if session.get('user_id') %}
      $("div#concert-results").on("click", "input.add-concert", addConcert);
    {% endif %}

    // Sort results on button click
    $("button.sort-by-date").on("click", sortConcerts);
    $("button.sort-by-artist").on("click", sortConcerts);

    // Make GET request to server and display recommended concerts
    if (authCode) {
      // Use Spotify authorization if authCode available
      $.get('/recs', {'auth-code': authCode}, findConcerts)

      // Display error message if GET request fails
          .fail(function(err){
            displayError("Spotify authorization failed <br>" +
                  err.status + ": " + err.statusText);
          });

    } else {
      // Use selected artists from template render if no auth
      $.get('/recs-from-search', selectedArtists, findConcerts)

      // Display error message if GET request fails
          .fail(function(err){
            displayError("Artist search failed <br>" +
                  err.status + ": " + err.statusText);
          });
    
    }


    // Make GET request to find concerts for each artist
    function findConcerts(artistRecs) {
      // If error message returned, display that message
      if (typeof artistRecs == 'string') {
        displayError(artistRecs);

      } else {
        // Initiate variables to keep track of end of get requests
        resultCount = 0;
        expectedResults = Object.keys(artistRecs).length;

        // Iterate throuh dictionary of recommended artists
        for (spotifyID in artistRecs) {
  
          // Make GET request to server for each artist and display concerts
          payload = {
            'spotify-id': spotifyID,
            'artist': artistRecs[spotifyID]
          };
          $.get('/concerts', payload, displayConcerts)

          // Display error message if GET request fails
              .fail(function(err){
                console.log("Concert search failed <br>" +
                      err.status + ": " + err.statusText);
                resultCount++;
              });
        }
      }
    }


    // Display concert recommendations from Songkick
    function displayConcerts(concertList) {

      // Iterate through list of concerts
      for (var i = 0; i < concertList.length; i++) {

        // Display the concert recommendations
        $("#concert-results").slideDown();

        // Create div for each concert and append to div#concert-results
        var recDiv = createRecDiv(concertList[i]).hide();
        $("#concert-results").append(recDiv);
        recDiv.slideDown();
      }

      // If this is part of last GET request, remove loading gif div
      resultCount++;
      if (resultCount === expectedResults) {

        // If there were no results, remove results div and display message
        if ($(".concert-rec").length == 0){
          displayError("We couldn't find any concerts based on your top artists in this area :(");

        // Otherwise, remove the loading div
        } else {
          $("#results-loading").fadeOut(); 
          $("#sort-results").slideDown();
        }
      }
    }


    // Display message in div#no-results 
    function displayError(error) {
      // Create h3 tag with error message
      var message = $("<h3>");
      message.text(error);

      // Remove loading and results divs
      $("#results-loading").slideUp();
      $("#concert-results").slideUp();

      // Add message to div#no-results and show the div
      $("#no-results").append(message);
      $("#no-results").fadeIn();
    }


    // Create a div.concert-rec for a concert object
    function createRecDiv(concert) {
      // Create a div with class concert-rec
      var concertDiv = $("<div>").addClass("concert-rec");

      // Set artist with bold tag 
      var artist = $("<b>").text(concert.artist);

      var artistImg;
      // Set image for artist if available
      if (concert.image_url) {
        var artistImg = "<br>" + $("<img>").attr("src", concert.image_url);
      }

      var source;
      // Set concert's source artist if available
      if (concert.source) {
        source = "<br>Recommended based on your interest in " + concert.source;
      }

      // Set display name with surrounding line breaks
      var displayName = "<br>" + concert.display_name + "<br>";

      var location;
      // Set location to city if available
      if (concert.city) {
        location = concert.city + "<br>";

        // Add concert venue to location if available
        if (concert.venue_name) {
          location = concert.venue_name + " in " + location;
        }
      }

      var start;
      // Set start date/time if available
      if (concert.start_datetime) {
        // Format start date/time with JS and moment.js
        var startISO = new Date(concert.start_datetime);
        var startMoment = moment(startISO).utc();
        var formattedStart = startMoment.format("ddd MMM DD, Y [at] LT")

        start = formattedStart + "<br>";
      }

      var url;
      // Set songkick url if available
      if (concert.songkick_url) {
        url = $("<a>").text("View this event on Songkick");
        url.attr({
          "href": concert.songkick_url,
          "target": "_blank",
        });
      }

      // Create a form for adding the concert
      var addForm = createAddConcertForm(concert);

      // Add all elements to concertDiv and return the div
      concertDiv.append(artist, artistImg, source, displayName, location, start, url, addForm, "<br>");
      return concertDiv;
    }


    // Create a hidden form for adding a concert
    function createAddConcertForm(concert) {
      // Create empty form
      var addForm = $("<form>");

      // Create hidden inputs for the concerts data
      var songkickID = $("<input>").attr("type", "hidden");
      songkickID.addClass("songkick-id").val(concert.songkick_id);

      var artist = $("<input>").attr("type", "hidden");
      artist.addClass("artist").val(concert.artist);

      var displayName = $("<input>").attr("type", "hidden");
      displayName.addClass("display-name").val(concert.display_name);

      var songkickURL = $("<input>").attr("type", "hidden");
      songkickURL.addClass("songkick-url").val(concert.songkick_url);

      var spotifyID = $("<input>").attr("type", "hidden");
      spotifyID.addClass("spotify-id").val(concert.spotify_id);

      var imageURL = $("<input>").attr("type", "hidden");
      imageURL.addClass("image-url").val(concert.image_url);

      var venue_name = $("<input>").attr("type", "hidden");
      venue_name.addClass("venue-name").val(concert.venue_name);
      
      var venue_lat = $("<input>").attr("type", "hidden");
      venue_lat.addClass("venue-lat").val(concert.venue_lat);

      var venue_lng = $("<input>").attr("type", "hidden");
      venue_lng.addClass("venue-lng").val(concert.venue_lng);

      var city = $("<input>").attr("type", "hidden");
      city.addClass("city").val(concert.city);

      var start = $("<input>").attr("type", "hidden");
      start.addClass("start-datetime").val(concert.start_datetime);

      // Create submit button
      var submit = $("<input>").attr("type", "submit");
      submit.addClass("btn add-concert")

      // If user logged in
      {% if session.get('user_id') %}

        // Disable submit button if concert in user's saved concerts
        if ( userSavedConcerts.includes( parseInt( songkickID.val() ) ) ) {
          submit.prop("disabled", true).val("Concert previously saved");

        // Enable submit button otherwise
        } else {
          submit.val("Add this concert");
        }

      // If user not logged in, disable submit button
      {% else %}
        submit.prop("disabled", true).val("Log in to save this concert");
      {% endif %}

      // Add all inputs to form and return it
      addForm.append(songkickID, artist, displayName, songkickURL, spotifyID, imageURL, venue_name, venue_lat, venue_lng, city, start, submit);
      return addForm;
    }

  </script>
{% endblock %}
