{% extends 'base.html' %}

{% block subtitle %}
  : Concert Recommendations
{% endblock %}

{% block content %}
  <h1>Results</h1>

  <div id="results-loading">
    <h2>FINDING CONCERTS...</h2>
    <img src="/static/img/load-hourglass.gif"><br>
    This may take a minute
  </div>

  <div id="concert-results" hidden>
    <h3>Concerts you might be interested in</h3>
  </div>

  <div id="no-results" hidden>
  </div>

{% endblock %}

{% block js %}
  <script>
    // Get variables with server
    var userSavedConcerts = {{ user_saved_concerts }};
    var authCode = "{{ auth_code }}";

    // Make GET request to server and display recommended concerts
    $.get('/recs', {'auth-code': authCode}, findConcerts);


    // Make GET request to find concerts for each artist
    function findConcerts(artistRecs) {
      // If error message returned, display that message
      if (typeof artistRecs == 'string') {
        displayError(artistRecs);

      } else {
        // Display the concert recommendations
        $("#concert-results").slideDown();
      
        // Iterate throuh dictionary of recommended artists
        for (spotifyID in artistRecs) {
  
          // Make GET request to server for each artist and display concerts
          payload = {
            'spotify-id': spotifyID,
            'artist': artistRecs[spotifyID]
          };
          $.get('/concerts', payload, displayConcerts);
        }
      }

      // Hide loading div
      $("#results-loading").slideUp();
    }


    // Display concert recommendations from Songkick
    function displayConcerts(concertList) {
      
      // Create div for each concert and append to div#concert-results
      for (var i = 0; i < concertList.length; i++) {
        var recDiv = createRecDiv(concertList[i]).hide();
        $("#concert-results").append(recDiv);
        recDiv.slideDown();
      }

      // If user logged in, addConcert on button click
      {% if session.get('user_id') %}
        $("input.add-concert").on("click", addConcert);

      // If user not logged in, disable button
      {% else %}
        $("input.add-concert").prop("disabled", true).val("Log in to save this concert");
      {% endif %}
    }


    // Display message in div#no-results 
    function displayError(error) {
      // Create h3 tag with error message
      var message = $("<h3>");
      message.text(error);

      // Add message to div#no-results and show the div
      $("#no-results").append(message);
      $("#no-results").fadeIn();
    }


    // Create a div.concert-rec for a concert object
    function createRecDiv(concert) {
      // Create a div with class concert-rec
      var concertDiv = $("<div>").addClass("concert-rec");

      // Set artist with bold tag 
      var artist = $("<b>").text(concert.artist);

      // Set display name with surrounding line breaks
      var displayName = "<br>" + concert.display_name + "<br>";

      var location;
      // Set location to city if available
      if (concert.city) {
        location = concert.city + "<br>";

        // Add concert venue to location if available
        if (concert.venue) {
          location = concert.venue + " in " + location;
        }
      }

      var start;
      // Set start date/time if available
      if (concert.start_datetime) {
        // Format start date/time with JS and moment.js
        var startISO = new Date(concert.start_datetime).toISOString();
        var startMoment = moment(startISO).utc();
        var formattedStart = startMoment.format("ddd MMM DD, Y [at] LT")

        start = formattedStart + "<br>";
      }

      var url;
      // Set songkick url if available
      if (concert.songkick_url) {
        url = $("<a>").text("View this event on Songkick");
        url.attr({
          "href": concert.songkick_url,
          "target": "_blank",
        });
      }

      // Create a form for adding the concert
      var addForm = createAddConcertForm(concert);

      // Add all elements to concertDiv and return the div
      concertDiv.append(artist, displayName, location, start, url, addForm, "<br>");
      return concertDiv;
    }


    // Create a hidden form for adding a concert
    function createAddConcertForm(concert) {
      // Create empty form
      var addForm = $("<form>");

      // Create hidden inputs for the concerts data
      var songkickID = $("<input>").attr("type", "hidden");
      songkickID.addClass("songkick-id").val(concert.songkick_id);

      var artist = $("<input>").attr("type", "hidden");
      artist.addClass("artist").val(concert.artist);

      var displayName = $("<input>").attr("type", "hidden");
      displayName.addClass("display-name").val(concert.display_name);

      var songkickURL = $("<input>").attr("type", "hidden");
      songkickURL.addClass("songkick-url").val(concert.songkick_url);

      var spotifyID = $("<input>").attr("type", "hidden");
      spotifyID.addClass("spotify-id").val(concert.spotify_id);

      var venue = $("<input>").attr("type", "hidden");
      venue.addClass("venue").val(concert.venue);

      var city = $("<input>").attr("type", "hidden");
      city.addClass("city").val(concert.city);

      var start = $("<input>").attr("type", "hidden");
      start.addClass("start-datetime").val(concert.start_datetime);

      // Create submit button
      var submit = $("<input>").attr("type", "submit");
      submit.addClass("add-concert").val("Add this concert");

      // Disable submit button if concert in user's saved concerts
      if ( userSavedConcerts.includes( parseInt( songkickID.val() ) ) ) {
        submit.prop("disabled", true).val("Concert previously saved");
      }

      // Add all inputs to form and return it
      addForm.append(songkickID, artist, displayName, songkickURL, spotifyID, venue, city, start, submit);
      return addForm;
    }

  </script>
{% endblock %}
