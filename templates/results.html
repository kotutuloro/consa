{% extends 'base.html' %}

{% block subtitle %}
  : Concert Recommendations
{% endblock %}

{% block content %}
  <h1>Results</h1>

  <div id="results-loading">
    <h2>FINDING CONCERTS...</h2>
    <img src="/static/img/load-hourglass.gif"><br>
    This may take a minute
  </div>

  <div id="concert-results" hidden>
    <h3>Concerts you might be interested in</h3>
  </div>

  <div id="no-results" hidden>
  </div>

{% endblock %}

{% block js %}
  <script>
    // Display concert recommendations from Songkick
    function displayRecs(recList) {
      // Hide loading div
      $("#results-loading").slideUp();

      // If error message returned, display that message
      if (typeof recList == 'string') {
        displayError(recList);

      // If no results, display message informing user
      } else if (recList.length === 0) {
        displayError("We couldn't find any concerts based on your top artists in this area :(");

      // If there are results, iterate through list of results
      } else {
        
        // Create div for each concert and append to div#concert-results
        for (var i = 0; i < recList.length; i++) {
          var recDiv = createRecDiv(recList[i]);
          $("#concert-results").append(recDiv);
        }

        // If user logged in, addConcert on button click
        {% if session.get('user_id') %}
          $("input.add-concert").on("click", addConcert);

        // If user not logged in, disable button
        {% else %}
          $("input.add-concert").prop("disabled", true).val("Log in to save this concert");
        {% endif %}

        // Display the concert recommendations
        $("#concert-results").slideDown();
      }
    }


    // Display message in div#no-results 
    function displayError(error) {
      // Create h3 tag with error message
      var message = $("<h3>");
      message.text(error);

      // Add message to div#no-results and show the div
      $("#no-results").append(message);
      $("#no-results").fadeIn();
    }


    // Create a div.concert-rec for a concert object
    function createRecDiv(concert) {
      // Create a div with class concert-rec
      var concertDiv = $("<div>").addClass("concert-rec");

      // Set artist with bold tag 
      var artist = $("<b>").text(concert.artist);

      // Set display name with surrounding line breaks
      var displayName = "<br>" + concert.display_name + "<br>";

      var location;
      // Set location to city if available
      if (concert.city) {
        location = concert.city + "<br>";

        // Add concert venue to location if available
        if (concert.venue) {
          location = concert.venue + " in " + location;
        }
      }

      var start;
      // Set start date/time if available
      if (concert.start_datetime) {
        // Format start date/time with JS and moment.js
        var startISO = new Date(concert.start_datetime).toISOString();
        var startMoment = moment(startISO).utc();
        var formattedStart = startMoment.format("ddd MMM DD, Y [at] LT")

        start = formattedStart + "<br>";
      }


      var url;
      // Set songkick url if available
      if (concert.songkick_url) {
        url = $("<a>").text("View this event on Songkick");
        url.attr({
          "href": concert.songkick_url,
          "target": "_blank",
        });
      }

      // Create a form for adding the concert
      var addForm = createAddConcertForm(concert);

      // Add all elements to concertDiv and return the div
      concertDiv.append(artist, displayName, location, start, url, addForm, "<br>");
      return concertDiv;
    }


    // Create a hidden form for adding a concert
    function createAddConcertForm(concert) {
      // Create empty form
      var addForm = $("<form>");

      // Create hidden inputs for the concerts data
      var songkickID = $("<input>").attr("type", "hidden");
      songkickID.addClass("songkick-id").val(concert.songkick_id);

      var artist = $("<input>").attr("type", "hidden");
      artist.addClass("artist").val(concert.artist);

      var displayName = $("<input>").attr("type", "hidden");
      displayName.addClass("display-name").val(concert.display_name);

      var songkickURL = $("<input>").attr("type", "hidden");
      songkickURL.addClass("songkick-url").val(concert.songkick_url);

      var spotifyID = $("<input>").attr("type", "hidden");
      spotifyID.addClass("spotify-id").val(concert.spotify_id);

      var venue = $("<input>").attr("type", "hidden");
      venue.addClass("venue").val(concert.venue);

      var city = $("<input>").attr("type", "hidden");
      city.addClass("city").val(concert.city);

      var start = $("<input>").attr("type", "hidden");
      start.addClass("start-datetime").val(concert.start_datetime);

      // Create submit button
      var submit = $("<input>").attr("type", "submit");
      submit.addClass("add-concert").val("Add this concert");

      // Add all inputs to form and return it
      addForm.append(songkickID, artist, displayName, songkickURL, spotifyID, venue, city, start, submit);
      return addForm;
    }



    // Get spotify auth code from server
    var authCode = "{{ auth_code }}";

    // Make GET request to server and display recommended concerts
    $.get('/recs', {'auth-code': authCode}, displayRecs);

  </script>
{% endblock %}
